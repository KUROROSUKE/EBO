let p1_hand=[],p2_hand=[],p1_point=0,p2_point=0,p1_selected_card=[],p2_selected_card=[];const card_num=8;let WIN_POINT=250,WIN_TURN=10,numTurn=0,dropped_cards_p1=[],dropped_cards_p2=[],is_ok_p1=!1,is_ok_p2=!1,p1_finish_select=!0,p2_finish_select=!0,p1_make_material={},turn="p1",time="game";const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(6).fill("H"),...[,,,,].fill("O"),...[,,,,].fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let deck=[...elements,...elements],materials=[],imageCache={};async function loadMaterials(){let e=await fetch("../compound/obf_standard_min.json"),n=await e.json();return n.material&&Array.isArray(n.material)?n.material:[]}async function preloadImages(){for(let e of[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53])try{let n=`../images/${e}.webp`;console.log(`Fetching image: ${n}`);let t=await fetch(n);if(console.log(`Response status for ${e}: ${t.status}`),!t.ok)throw Error(`Failed to load image: ${e}`);let a=await t.blob();if(!a)throw Error(`Blob is null for image ${e}`);imageCache[e]=a,console.log(`Loaded image: ${e}`,a)}catch(l){console.error(`Image loading error: ${e}`,l)}}async function init_json(){materials=await loadMaterials()}async function view_p2_hand(){let e=document.getElementById("p2_hand");p2_hand.forEach((n,t)=>{let a=imageCache[elementToNumber[n]],l=new Image;l.src=URL.createObjectURL(a),l.alt=n,l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),l.addEventListener("click",function(){let e=document.getElementById("ron_button");if(e.style.display="none","make"==time&&(this.classList.toggle("selected"),this.classList.contains("selected")?(this.style.border="1px solid #000",this.style.padding="5px",p2_selected_card.splice(p2_selected_card.indexOf(this.alt),1)):(this.style.border="5px solid #F00",this.style.padding="1px",p2_selected_card.push(this.alt))),turn==name&&"game"==time){dropped_cards_p2.push(this.alt),a.alt=this.alt;let n=imageCache[elementToNumber[this.alt]],a=new Image;a.src=URL.createObjectURL(n),a.style.border="1px solid #000",document.getElementById("dropped_area_p2").appendChild(a),this.classList.remove("selected"),this.classList.add("selected");let l=drawCard(),i=imageCache[elementToNumber[l]],o=new Image;o.src=URL.createObjectURL(i),o.alt=l,o.style.padding="5px",o.style.border="1px solid #000",p2_hand[t]=l,this.replaceWith(o),changeTurn(turn="p2"==turn?"p1":"p2"),shareAction(action="exchange",otherData=a.alt)}}),e.appendChild(l)})}async function view_p1_hand(){let e=document.getElementById("p1_hand");p1_hand.forEach((n,t)=>{let a=imageCache[0],l=new Image;l.src=URL.createObjectURL(a),l.alt="相手の手札",l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),e.appendChild(l)})}async function p2_make(){time="make",document.getElementById("generate_button").style.display="none",document.getElementById("ron_button").style.display="none";let e=document.getElementById("done_button");e.style.display="inline",e.replaceWith(e.cloneNode(!0));let n=document.getElementById("done_button");return new Promise(e=>{n.addEventListener("click",function(){let n=document.getElementById("done_button");n.style.display="none";let t=search(arrayToObj(p2_selected_card));e(t),finishSelect()})})}async function done(e,n=!1){let t=await p2_make();await new Promise(e=>{let n=setInterval(()=>{p1_finish_select||p2_finish_select||(clearInterval(n),e())},100)}),"p2"===name&&(console.log("done"),finish_done_select(p1_make_material,t,e,n))}async function finish_done_select(e,n,t,a=!1){dora=await get_dora();let l=n.c,i=e.c;Boolean(n.e.includes(e.b))?l*=1.5+Math.random()/2:Boolean(e.e.includes(n.b))&&(i*=1.5+Math.random()/2),Boolean(Object.keys(n.d).includes(dora))?l*=1.5:Boolean(Object.keys(e.d).includes(dora))&&(i*=1.5),a&&("p2"==t?l/=1.2:i/=1.2),"p2"==t?i/=1.5:l/=1.5,l=Math.round(l),p1_point+=await (i=Math.round(i)),p2_point+=await l,console.log(i),console.log(l),document.getElementById("p2_point").innerHTML+=`+${l}`,document.getElementById("p1_point").innerHTML+=`+${i}`,document.getElementById("p2_explain").innerHTML=`生成物質：${n.a}, 組成式：${n.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${e.a}, 組成式：${e.b}`,sharePoints(),winnerAndChangeButton()}function waitUntilBothTrue(e,n,t=100){return new Promise(a=>{let l=setInterval(()=>{e()&&n()&&(clearInterval(l),a())},t)})}async function winnerAndChangeButton(){let e=await win_check();document.getElementById("done_button").style.display="none";let n=document.getElementById("nextButton");n.style.display="inline",e?(console.log("ラウンド終了"),n.textContent="ラウンド終了",n.addEventListener("click",function(){returnToStartScreen(),p1_point=0,p2_point=0,numTurn=0,resetGame(),n.style.display="none";let e=n.cloneNode(!0);n.parentNode.replaceChild(e,n),conn.close()})):(console.log("次のゲーム"),n.textContent="次のゲーム",n.addEventListener("click",async function(){is_ok_p2=!0,nextIsOK(),n.style.display="none",console.log("OK"),await waitUntilBothTrue(()=>is_ok_p1,()=>is_ok_p2),is_ok_p1=!1,is_ok_p2=!1,numTurn+=1,resetGame();let e=n.cloneNode(!0);n.parentNode.replaceChild(e,n)}))}async function checkRon(e){let n=await search_materials(arrayToObj([...p2_hand,e])),t=n.filter(n=>n.d[e]);if(t.length>0){let a=document.getElementById("ron_button");a.style.display="inline",a.replaceWith(a.cloneNode(!0));let l=document.getElementById("ron_button");l.addEventListener("click",function(){l.style.display="none",p2_selected_card=[e],p2_make();let n=document.getElementById("dropped_area_p1").children,t=n[n.length-1];t.style.border="2px solid red",shareAction(action="generate",otherData=name)})}}function drawCard(){return deck.length>0?deck.pop():(time="make",done("no-draw"))}function shuffle(e){let n=e.length;for(;0!=n;){let t=Math.floor(Math.random()*n);n--,[e[n],e[t]]=[e[t],e[n]]}return e}function arrayToObj(e){let n={};return e.forEach(e=>{n[e]?n[e]++:n[e]=1}),n}async function search_materials(e){return materials.filter(n=>{for(let t in n.d)if(!e[t]||n.d[t]>e[t])return!1;return!0})}function random_hand(){for(let e=0;e<8;e++)p1_hand.push(drawCard()),p2_hand.push(drawCard())}async function search(e){return materials.find(n=>{for(let t in e)if(!n.d[t]||n.d[t]!==e[t])return!1;for(let a in n.d)if(!e[a])return!1;return!0})||materials[0]}async function get_dora(){return element[Math.round(23*Math.random())]}async function win_check(){return Math.abs(p1_point-p2_point)>=WIN_POINT?p1_point>p2_point?"p1":"p2":numTurn>=WIN_TURN?p1_point>p2_point?"p1":"p2":null}document.addEventListener("DOMContentLoaded",function(){preloadImages().then(e=>{init_json(),deck=shuffle(deck=[...elements,...elements]),random_hand(),view_p1_hand(),view_p2_hand(),turn="p1"})});const generate_Button=document.getElementById("generate_button");function returnToStartScreen(){document.getElementById("startScreen").style.display="flex",document.getElementById("p1_area").style.display="none",document.getElementById("dropped_area_p1").style.display="none",document.getElementById("dropped_area_p2").style.display="none",document.getElementById("p2_area").style.display="none",document.getElementById("gameRuleButton").style.display="block"}function resetGame(){p1_hand=[],p2_hand=[],dropped_cards_p1=[],dropped_cards_p2=[],p1_selected_card=[],p2_selected_card=[],time="game",turn="p1",p1_finish_select=!0,p2_finish_select=!0,document.getElementById("p1_point").innerHTML=`ポイント：${p1_point}`,document.getElementById("p1_explain").innerHTML="　",document.getElementById("p2_point").innerHTML=`ポイント：${p2_point}`,document.getElementById("p2_explain").innerHTML="　","p1"==name&&(document.getElementById("generate_button").style.display="inline"),document.getElementById("done_button").style.display="none",document.getElementById("nextButton").style.display="none",deck=shuffle(deck=[...elements,...elements]);let e=document.getElementById("p1_hand"),n=document.getElementById("p2_hand");e.innerHTML="",n.innerHTML="";let t=document.getElementById("dropped_area_p1"),a=document.getElementById("dropped_area_p2");t.innerHTML="",a.innerHTML="",random_hand(),view_p1_hand(),view_p2_hand()}function startGame(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none"}function showRules(){document.getElementById("rulesModal").style.display="block"}function closeRules(){document.getElementById("rulesModal").style.display="none"}function openWinSettings(){document.getElementById("winSettingsModal").style.display="block"}function closeWinSettings(){document.getElementById("winSettingsModal").style.display="none"}generate_Button.addEventListener("click",function(){turn===name&&(time="make",p2_make(),shareAction(action="generate",otherData=name))}),window.onclick=function(e){let n=document.getElementById("rulesModal");e.target===n&&closeRules()},document.getElementById("closeRulesButton").addEventListener("click",closeRules),document.getElementById("setting_icon").addEventListener("click",function(){document.getElementById("winSettingsModal").style.display="inline"});const roomName=prompt("設定するIDを入力してください:"),peer=new Peer(roomName);let conn,name=null;function connectToPeer(){null===name&&(name="p1");let e=document.getElementById("remote-id").value;document.getElementById("winSettingsModal").style.display="none",conn=peer.connect(e),setupConnection()}function setupConnection(){conn.on("open",()=>{"p1"===name&&(conn.send({type:"role",value:"p2"}),conn.send({type:"turn",value:turn}),turn!=name?document.getElementById("generate_button").style.display="none":search_materials(arrayToObj(p2_hand))&&(document.getElementById("generate_button").style.display="inline")),document.getElementById("winSettingsModal").style.display="none",shareVariable(),startGame()}),conn.on("data",e=>{if("role"===e.type&&null===name&&(name=e.value),"turn"===e.type&&((turn=e.value)!=name?document.getElementById("generate_button").style.display="none":search_materials(arrayToObj(p2_hand))&&(document.getElementById("generate_button").style.display="inline")),"action"===e.type){if("exchange"==e.action){deck=e.deck,dropped_cards_p1.push(e.otherData);let n=imageCache[elementToNumber[e.otherData]],t=new Image;t.src=URL.createObjectURL(n),t.alt=e.otherData,t.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(t),checkRon(e.otherData)}else"generate"==e.action&&(console.log("generate this in get action of generate"),p2_make())}"selected"===e.type&&(p1_finish_select=!1,p1_make_material=e.otherData,p2_finish_select||(console.log("get p1 selected & do finish_done_select"),finish_done_select(p1_make_material,p2_make_material,"p1"))),"pointsData"===e.type&&(document.getElementById("p1_point").innerHTML+=`+${e.p1_point-p1_point}`,document.getElementById("p2_point").innerHTML+=`+${e.p2_point-p2_point}`,document.getElementById("p1_explain").innerHTML=e.p1_explain,document.getElementById("p2_explain").innerHTML=e.p2_explain,p1_point=e.p1_point,p2_point=e.p2_point,winnerAndChangeButton()),"nextIsOK"===e.type&&(is_ok_p1=!0),void 0!==e.p1_hand&&(p1_hand=e.p1_hand),void 0!==e.deck&&(deck=e.deck)})}function shareVariable(){conn&&conn.open&&("p1"===name?conn.send({p1_hand:p2_hand,deck:deck,turn:turn}):conn.send({p1_hand:p2_hand}))}function shareAction(e,n){conn&&conn.open?conn.send({type:"action",action:e,otherData:n,deck:deck}):console.error("⚠️ 接続が開かれていません！ アクションを送信できません。")}function changeTurn(e){conn&&conn.open&&(conn.send({type:"turn",value:e}),turn!=name?document.getElementById("generate_button").style.display="none":search_materials(arrayToObj(p2_hand))&&(document.getElementById("generate_button").style.display="inline"))}async function finishSelect(){conn&&conn.open&&(p2_make_material=await search(arrayToObj(p2_selected_card)),conn.send({type:"selected",value:name,otherData:p2_make_material}),p2_finish_select=!1)}async function sharePoints(){conn&&conn.open&&(p1_explain_copy=document.getElementById("p2_explain").textContent,p2_explain_copy=document.getElementById("p1_explain").textContent,conn.send({type:"pointsData",p1_point:p2_point,p1_explain:p1_explain_copy,p2_point:p1_point,p2_explain:p2_explain_copy}))}async function nextIsOK(){conn&&conn.open&&conn.send({type:"nextIsOK",content:!0})}peer.on("open",e=>{console.log(e),document.getElementById("my-id").innerText=`自分のPeerID：${e}`,document.getElementById("winSettingsModal").style.display="none"}),peer.on("connection",e=>{conn=e,null===name&&(name="p2"),setupConnection()});